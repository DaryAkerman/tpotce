name: Security (CodeQL + linters)

on:
  push:
    branches: ["master"]
  pull_request:
    branches: ["master"]
  schedule:
    - cron: "17 03 * * 1" # weekly

permissions:
  contents: read
  security-events: write

jobs:
  codeql:
    name: CodeQL (Python + GitHub Actions)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v4
        with:
          # IMPORTANT: must be a YAML list (not a multiline string)
          languages: python
          queries: security-extended

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v4

      # Fail only if CodeQL has HIGH/CRITICAL alerts for this exact commit
      - name: Fail if High/Critical CodeQL alerts exist
        env:
          GH_TOKEN: ${{ github.token }}
          REPO: ${{ github.repository }}
          REF: ${{ github.sha }}
        run: |
          set -euo pipefail
          echo "Checking CodeQL alerts for $REPO at $REF ..."

          for i in {1..12}; do
            critical_count="$(gh api -H "Accept: application/vnd.github+json" \
              "/repos/$REPO/code-scanning/alerts?state=open&tool_name=CodeQL&severity=critical&ref=$REF&per_page=100" \
              | jq 'length')"

            high_count="$(gh api -H "Accept: application/vnd.github+json" \
              "/repos/$REPO/code-scanning/alerts?state=open&tool_name=CodeQL&severity=high&ref=$REF&per_page=100" \
              | jq 'length')"

            total=$((critical_count + high_count))
            echo "High: $high_count | Critical: $critical_count | Total: $total"

            if [ "$total" -gt 0 ]; then
              echo "❌ Failing: found High/Critical CodeQL alerts."
              exit 1
            fi

            # allow a little time for alerts to appear after upload
            sleep 10
          done

          echo "✅ No High/Critical CodeQL alerts found."

  powershell_lint:
    name: PowerShell (PSScriptAnalyzer)
    runs-on: ubuntu-latest
    # Optional: don’t block merges on ps1 lint (set to false if you want it blocking)
    continue-on-error: true

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run PSScriptAnalyzer
        shell: pwsh
        run: |
          Set-StrictMode -Version Latest
          Install-Module PSScriptAnalyzer -Force -Scope CurrentUser

          $files = Get-ChildItem -Path . -Recurse -File -Filter *.ps1
          if (-not $files) {
            Write-Host "No .ps1 files found."
            exit 0
          }

          $results = Invoke-ScriptAnalyzer -Path $files.FullName -Recurse -Severity Warning,Error
          if ($results) {
            $results | Format-Table -AutoSize
            throw "PSScriptAnalyzer found issues."
          }

  dockerfile_lint:
    name: Dockerfiles (hadolint)
    runs-on: ubuntu-latest
    # Optional: don’t block merges on Dockerfile lint
    continue-on-error: true

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install hadolint
        run: |
          sudo wget -O /usr/local/bin/hadolint https://github.com/hadolint/hadolint/releases/latest/download/hadolint-Linux-x86_64
          sudo chmod +x /usr/local/bin/hadolint
          hadolint --version

      - name: Lint all Dockerfiles recursively
        run: |
          set -euo pipefail
          mapfile -t files < <(find . -type f \( -name 'Dockerfile' -o -name 'Dockerfile.*' -o -name '*Dockerfile*' \))
          if [ "${#files[@]}" -eq 0 ]; then
            echo "No Dockerfiles found."
            exit 0
          fi

          for f in "${files[@]}"; do
            echo "==> hadolint $f"
            hadolint "$f"
          done

  yaml_lint:
    name: YAML (workflows only)
    runs-on: ubuntu-latest
    # Optional: don’t block merges on YAML lint
    continue-on-error: true

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install yamllint
        run: |
          python -m pip install --upgrade pip
          pip install yamllint

      - name: Lint GitHub workflows only
        run: |
          yamllint .github/workflows