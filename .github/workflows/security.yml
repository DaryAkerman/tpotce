name: Security (CodeQL + linters + summary)

on:
  push:
    branches: ["master"]
  pull_request:
    branches: ["master"]
  schedule:
    - cron: "17 03 * * 1"

permissions:
  contents: read
  security-events: write

jobs:
  codeql:
    name: CodeQL (Python + GitHub Actions)
    runs-on: ubuntu-latest

    outputs:
      high: ${{ steps.gate.outputs.high }}
      critical: ${{ steps.gate.outputs.critical }}
      pass: ${{ steps.gate.outputs.pass }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v4
        with:
          languages: python
          queries: security-extended

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v4

      - name: Gate (fail only on High/Critical)
        id: gate
        env:
          GH_TOKEN: ${{ github.token }}
          REPO: ${{ github.repository }}
          REF: ${{ github.sha }}
        run: |
          set -euo pipefail
          echo "high=0" >> "$GITHUB_OUTPUT"
          echo "critical=0" >> "$GITHUB_OUTPUT"
          echo "pass=V" >> "$GITHUB_OUTPUT"

          # Alerts can lag a bit after upload, retry briefly
          for i in {1..12}; do
            critical_count="$(gh api -H "Accept: application/vnd.github+json" \
              "/repos/$REPO/code-scanning/alerts?state=open&tool_name=CodeQL&severity=critical&ref=$REF&per_page=100" \
              | jq 'length')"

            high_count="$(gh api -H "Accept: application/vnd.github+json" \
              "/repos/$REPO/code-scanning/alerts?state=open&tool_name=CodeQL&severity=high&ref=$REF&per_page=100" \
              | jq 'length')"

            echo "high=$high_count" >> "$GITHUB_OUTPUT"
            echo "critical=$critical_count" >> "$GITHUB_OUTPUT"

            total=$((critical_count + high_count))
            if [ "$total" -gt 0 ]; then
              echo "pass=!" >> "$GITHUB_OUTPUT"
              echo "❌ High/Critical CodeQL alerts found (High=$high_count Critical=$critical_count)."
              exit 1
            fi

            sleep 10
          done

          echo "✅ No High/Critical CodeQL alerts found."

  powershell_lint:
    name: PowerShell (PSScriptAnalyzer)
    runs-on: ubuntu-latest
    continue-on-error: true

    outputs:
      issues: ${{ steps.ps.outputs.issues }}
      pass: ${{ steps.ps.outputs.pass }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run PSScriptAnalyzer (per file)
        id: ps
        shell: pwsh
        run: |
          Set-StrictMode -Version Latest

          if (-not (Get-Module -ListAvailable -Name PSScriptAnalyzer)) {
            Install-Module PSScriptAnalyzer -Force -Scope CurrentUser -AllowClobber
          }

          $files = Get-ChildItem -Path . -Recurse -File -Filter *.ps1
          if (-not $files) {
            "issues=0" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
            "pass=V"   | Out-File -FilePath $env:GITHUB_OUTPUT -Append
            Write-Host "No .ps1 files found."
            exit 0
          }

          $allFindings = @()
          foreach ($f in $files) {
            Write-Host "==> Analyzing $($f.FullName)"
            $r = Invoke-ScriptAnalyzer -Path $f.FullName -Severity Warning,Error
            if ($r) { $allFindings += $r }
          }

          $count = $allFindings.Count
          "issues=$count" | Out-File -FilePath $env:GITHUB_OUTPUT -Append

          if ($count -gt 0) {
            "pass=!" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
            $allFindings | Sort-Object Path, Line, RuleName | Format-Table -AutoSize
            throw "PSScriptAnalyzer found issues."
          } else {
            "pass=V" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
            Write-Host "PSScriptAnalyzer: OK"
          }

  dockerfile_lint:
    name: Dockerfiles (hadolint)
    runs-on: ubuntu-latest

    outputs:
      files: ${{ steps.hado.outputs.files }}
      warnings: ${{ steps.hado.outputs.warnings }}
      errors: ${{ steps.hado.outputs.errors }}
      pass: ${{ steps.hado.outputs.pass }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install hadolint
        run: |
          sudo wget -O /usr/local/bin/hadolint https://github.com/hadolint/hadolint/releases/latest/download/hadolint-Linux-x86_64
          sudo chmod +x /usr/local/bin/hadolint
          hadolint --version

      - name: Lint Dockerfiles recursively (never fail job)
        id: hado
        run: |
          set -euo pipefail

          echo "files=0" >> "$GITHUB_OUTPUT"
          echo "warnings=0" >> "$GITHUB_OUTPUT"
          echo "errors=0" >> "$GITHUB_OUTPUT"
          echo "pass=V" >> "$GITHUB_OUTPUT"

          mapfile -t files < <(find . -type f \( -name 'Dockerfile' -o -name 'Dockerfile.*' -o -name '*Dockerfile*' \))
          if [ "${#files[@]}" -eq 0 ]; then
            echo "No Dockerfiles found."
            exit 0
          fi

          warn=0
          err=0

          for f in "${files[@]}"; do
            echo "==> hadolint $f"
            set +e
            out="$(hadolint "$f" 2>&1)"
            rc=$?
            set -e

            # Print output (so you still see details in logs)
            if [ -n "$out" ]; then
              echo "$out"
            fi

            # Count reported severities
            wcount="$(printf "%s\n" "$out" | grep -E " warning:" -c || true)"
            ecount="$(printf "%s\n" "$out" | grep -E " error:|unexpected " -c || true)"

            warn=$((warn + wcount))
            err=$((err + ecount))

            # IMPORTANT: we do NOT exit non-zero, ever
            # even if rc != 0
          done

          echo "files=${#files[@]}" >> "$GITHUB_OUTPUT"
          echo "warnings=$warn" >> "$GITHUB_OUTPUT"
          echo "errors=$err" >> "$GITHUB_OUTPUT"

          # pass stays V so the job shows green.
          # We'll still report issues in the summary.

  yaml_lint:
    name: YAML (workflows only)
    runs-on: ubuntu-latest
    continue-on-error: true

    outputs:
      issues: ${{ steps.yl.outputs.issues }}
      pass: ${{ steps.yl.outputs.pass }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install yamllint
        run: |
          python -m pip install --upgrade pip
          pip install yamllint

      - name: Lint workflows only (count issues)
        id: yl
        run: |
          set -euo pipefail
          echo "issues=0" >> "$GITHUB_OUTPUT"
          echo "pass=V" >> "$GITHUB_OUTPUT"

          set +e
          out="$(yamllint .github/workflows 2>&1)"
          rc=$?
          set -e

          if [ $rc -ne 0 ]; then
            echo "$out"
            # rough count: each issue is typically one line
            cnt="$(printf "%s\n" "$out" | grep -vE '^\s*$' | wc -l | tr -d ' ')"
            echo "issues=$cnt" >> "$GITHUB_OUTPUT"
            echo "pass=!" >> "$GITHUB_OUTPUT"
            exit 1
          fi

  summary:
    name: Summary
    runs-on: ubuntu-latest
    needs: [codeql, powershell_lint, dockerfile_lint, yaml_lint]
    if: always()

    steps:
      - name: Write summary table
        run: |
          {
            echo "## Security scan summary"
            echo ""
            echo "| Check | Status | Details |"
            echo "|---|---:|---|"
            echo "| CodeQL (High/Critical gate) | ${{ needs.codeql.outputs.pass }} | High=${{ needs.codeql.outputs.high }}, Critical=${{ needs.codeql.outputs.critical }} |"
            echo "| PSScriptAnalyzer (.ps1) | ${{ needs.powershell_lint.outputs.pass }} | Findings=${{ needs.powershell_lint.outputs.issues }} |"
            echo "| hadolint (Dockerfiles) | ${{ needs.dockerfile_lint.outputs.pass }} | Dockerfiles=${{ needs.dockerfile_lint.outputs.files }}, Warnings=${{ needs.dockerfile_lint.outputs.warnings }}, Errors=${{ needs.dockerfile_lint.outputs.errors }} |"
            echo "| yamllint (workflows) | ${{ needs.yaml_lint.outputs.pass }} | Issues=${{ needs.yaml_lint.outputs.issues }} |"
            echo ""
            echo "**Legend:** `V` = job green/succeeded, `!` = issues found (may still be non-blocking depending on job settings)."
          } >> "$GITHUB_STEP_SUMMARY"